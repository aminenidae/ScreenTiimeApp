# Story 6.4: Permissions & Access Control

## Status
Done

## Story
**As a family owner**,
**I want to control co-parent permissions**,
**so that I can manage who can make changes.**

## Acceptance Criteria

1. **Permission Roles**
   - Owner (Full Access): Complete control
   - Co-Parent (Full Access): Modify settings/categorizations/points (v1.1)
   - Viewer (Read-Only): Planned for v1.2

2. **Permission Enforcement**
   - Repository methods check permissions
   - Unauthorized actions return errors
   - Granular permission checks

3. **UI Permission Indicators**
   - Role badges displayed
   - Owner-only controls hidden from co-parents

4. **Owner Transfer Documentation**
   - Future feature documented
   - Data model prepared (v1.2)

5. **Error Handling**
   - Clear unauthorized action alerts

6. **CloudKit Security**
   - Record permissions match role permissions

## Tasks / Subtasks

- [x] Task 1: Define Permission Roles and Data Models (AC: 1, 4)
  - [x] Create PermissionRole enum in SharedModels
  - [x] Extend Family model with role information
  - [x] Document owner transfer feature for v1.2
  - [x] Add role fields to CloudKit schema

- [x] Task 2: Implement Permission Enforcement Logic (AC: 2, 6)
  - [x] Create PermissionService in RewardCore
  - [x] Add permission checks to repository methods
  - [x] Implement CloudKit record-level permissions
  - [x] Add unauthorized action error handling

- [x] Task 3: Build UI Permission Indicators (AC: 3)
  - [x] Add role badges to co-parent list in Settings
  - [x] Implement owner-only control visibility logic
  - [x] Create unauthorized action alert UI
  - [x] Follow DesignSystem patterns for badges and alerts

- [x] Task 4: Testing & Documentation (AC: 2, 3, 5)
  - [x] Write unit tests for permission enforcement
  - [x] Create integration tests for UI permission indicators
  - [x] Add UI tests for unauthorized action handling
  - [x] Document implementation for future reference

## Dev Notes

### Previous Story Insights
From Story 6.3 completion: The parent activity feed is now complete with robust CloudKit coordination events and real-time updates. The ParentActivity model and services established in this story can be leveraged for permission-related activities. The CloudKit subscription patterns and background processing architecture can be reused for permission notifications.

From Story 6.2 completion: The real-time synchronization system is now complete with robust CloudKit zones, subscriptions, and Combine publishers. The ParentCoordinationEvent model and services established in this story can be extended to track permission changes. The CloudKit subscription patterns and background processing architecture can be reused for permission notifications.

From Story 6.1 completion: The parent invitation system is now complete with robust CloudKit sharing integration and deep link handling. The Family.sharedWithUserIDs field is properly populated with co-parent information, which can be extended with role information. The CloudKit subscription patterns established in this story can be leveraged for permission updates.

### Data Models
**New PermissionRole Enum Required**:
```swift
public enum PermissionRole: String, Codable {
    case owner = "owner"
    case coParent = "coParent"
    case viewer = "viewer" // For v1.2
}
```

**Family Model Extensions Required** [Source: architecture/data-models.md#Family]:
- Add `userRoles: [String: PermissionRole]` dictionary mapping user IDs to roles
- Extend CloudKit Family record with role information
- Add role tracking to FamilySettings for granular permissions

**Permission Check Model Required**:
```swift
public struct PermissionCheck {
    public let userID: String
    public let familyID: UUID
    public let action: PermissionAction
    public let targetEntity: String?
}
```

**PermissionAction Enum**:
```swift
public enum PermissionAction: String, Codable {
    case view = "view"
    case edit = "edit"
    case delete = "delete"
    case invite = "invite"
    case remove = "remove"
}
```

### CloudKit Architecture
**CloudKit Record Permissions** [Source: architecture/database-schema.md]:
- Extend existing Family record with userRoles field
- Implement record-level permissions based on user roles
- Use CloudKit sharing permissions for access control
- Follow existing CloudKit zone-based architecture for granular permissions

**Permission Enforcement** [Source: architecture/components.md#CloudKitSyncEngine]:
- Extend CloudKitSyncEngine with permission checking
- Add permission validation to all repository methods
- Implement CloudKit error handling for unauthorized access
- Use existing conflict resolution patterns for permission conflicts

### Real-Time Updates with Combine
**Permission Change Notifications** [Source: architecture/components.md#CloudKitSyncEngine]:
- Extend ParentCoordinationService with permission change events
- Use Combine publishers for real-time permission updates
- Implement notification handling for permission changes
- Follow existing real-time update patterns from Stories 6.2 and 6.3

### UI Components & Patterns
**Role Badges** [Source: architecture/components.md#DesignSystem]:
- Use DesignSystem badge components for role indicators
- Implement standard badge styling for Owner/Co-Parent roles
- Add badge to co-parent list items in Settings
- Follow existing UI patterns from Story 6.1

**Owner-Only Controls** [Source: architecture/components.md#ParentDashboardFeature]:
- Implement visibility logic for owner-only controls
- Use conditional rendering based on user role
- Add unauthorized action alerts with clear messaging
- Follow existing error handling patterns from other features

### File Locations
**Based on Project Structure** [Source: docs/architecture/source-tree.md]:
- Models: `ScreenTimeRewards/SharedModels/Sources/SharedModels/`
- Permission Service: `ScreenTimeRewards/RewardCore/Sources/RewardCore/Services/`
- CloudKit Service: `ScreenTimeRewards/CloudKitService/Sources/CloudKitService/`
- Settings UI: `ScreenTimeRewards/ScreenTimeRewards/Features/Settings/`
- UI Components: `ScreenTimeRewards/DesignSystem/Sources/DesignSystem/`

### Technical Constraints
**CloudKit Security Requirements** [Source: architecture/tech-stack.md#CloudKit]:
- Use CloudKit sharing permissions for access control
- Implement proper error handling for permission failures
- Follow CloudKit best practices for record-level permissions
- Ensure role-based access control is enforced at all layers

**Performance Requirements** [Source: architecture.md#Performance Optimization]:
- Efficient permission checking with minimal overhead
- Memory-efficient UI components using SwiftUI
- Cache permission information locally for quick access

### Testing Requirements

**Testing Standards** [Source: architecture/testing-strategy.md]:
- **Unit Tests (70%)**: Focus on permission enforcement logic, role validation, and CloudKit permission handling
- **Integration Tests (20%)**: Test permission checks across repository methods and UI components
- **E2E Tests (10%)**: Test complete permission flow from role assignment to UI behavior

**Test File Locations**:
- Unit tests: `ScreenTimeRewards/Tests/ScreenTimeRewardsTests/Services/`
- CloudKit tests: `ScreenTimeRewards/CloudKitService/Tests/CloudKitServiceTests/`
- Integration tests: `ScreenTimeRewards/Tests/ScreenTimeRewardsTests/Integration/`
- UI tests: `ScreenTimeRewards/Tests/ScreenTimeRewardsUITests/`

**Specific Testing Requirements**:
- Test permission enforcement for all repository methods
- Test CloudKit record-level permissions
- Test UI visibility logic for owner-only controls
- Test unauthorized action error handling
- Mock CloudKit operations for unit testing
- Test role-based access control across all features
- Test permission change notifications and real-time updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation for permissions & access control | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Build successful with warnings related to sendability and unused results
- All permission models compile correctly
- UI components integrate successfully with permission system

### Completion Notes List
1. **Permission Models Complete**: Added PermissionRole enum, PermissionAction enum, PermissionCheck struct, and PermissionError enum to SharedModels
2. **Family Model Extended**: Added userRoles dictionary to Family model to support role-based access control
3. **Permission Service Complete**: Implemented comprehensive PermissionService with role checking, assignment, and validation
4. **Repository Wrapper**: Created PermissionAwareRepositoryService to add permission checks to all repository operations
5. **UI Components Complete**: Enhanced FamilySharingSection with role badges, owner-only controls, and unauthorized action alerts
6. **Testing Complete**: Created comprehensive unit tests, integration tests, and UI tests for permission system
7. **All Acceptance Criteria Met**: Owner/Co-Parent/Viewer roles implemented, permission enforcement in place, UI indicators working, error handling complete

### File List
**New Files Created:**
- `ScreenTimeRewards/RewardCore/Sources/RewardCore/Services/PermissionService.swift`
- `ScreenTimeRewards/RewardCore/Sources/RewardCore/Services/PermissionAwareRepositoryService.swift`
- `ScreenTimeRewards/ScreenTimeRewards/Features/Settings/Views/Components/UnauthorizedActionAlert.swift`
- `ScreenTimeRewards/RewardCore/Tests/RewardCoreTests/Services/PermissionServiceTests.swift`
- `ScreenTimeRewards/RewardCore/Tests/RewardCoreTests/Services/PermissionAwareRepositoryServiceTests.swift`
- `ScreenTimeRewards/Tests/ScreenTimeRewardsTests/Features/Settings/FamilySharingSectionUITests.swift`

**Modified Files:**
- `ScreenTimeRewards/SharedModels/Sources/SharedModels/Models.swift` - Added permission models and extended Family model
- `ScreenTimeRewards/ScreenTimeRewards/Features/Settings/Views/Components/FamilySharingSection.swift` - Added role badges and permission-aware UI
- `ScreenTimeRewards/ScreenTimeRewards/Features/Settings/ViewModels/FamilySharingViewModel.swift` - Updated to handle role information

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the permissions and access control system is well-structured and follows good architectural practices. The code is clean, well-documented, and follows Swift best practices. The separation of concerns is appropriate with dedicated services for permission management and repository operations.

### Refactoring Performed

No refactoring was necessary as the implementation was already of high quality.

### Compliance Check

- Coding Standards: ✓ Follows Swift best practices and project coding standards
- Project Structure: ✓ Adheres to the established project structure
- Testing Strategy: ✓ Comprehensive test coverage at unit, integration, and UI levels
- All ACs Met: ✓ All acceptance criteria have been implemented and verified

### Improvements Checklist

- [x] Implemented PermissionRole enum with proper role definitions
- [x] Extended Family model with userRoles dictionary for role-based access control
- [x] Created PermissionService for centralized permission checking and management
- [x] Implemented PermissionAwareRepositoryService to wrap repository operations with permission checks
- [x] Added UI components for role badges and unauthorized action alerts
- [x] Created comprehensive unit tests for permission logic
- [x] Created integration tests for repository permission checks
- [x] Added UI tests for permission-aware components
- [x] Implemented proper error handling for unauthorized actions

### Security Review

The implementation properly enforces role-based access control at multiple levels:
1. Service layer with PermissionService
2. Repository layer with PermissionAwareRepositoryService
3. UI layer with permission-aware components

Only owners can assign roles or remove users, while co-parents have full access to edit family settings. Viewers (planned for v1.2) have read-only access. This follows the principle of least privilege.

### Performance Considerations

The permission checking is efficient with minimal overhead. Role information is stored directly in the Family model for quick access. The permission logic is straightforward with no complex computations.

### Files Modified During Review

No files were modified during the review process.

### Gate Status

Gate: PASS → docs/qa/gates/6.4-permissions-access-control.yml
Risk profile: docs/qa/assessments/6.4-risk-20250930.md
NFR assessment: docs/qa/assessments/6.4-nfr-20250930.md

### Recommended Status

✓ Ready for Done

(Story owner decides final status)