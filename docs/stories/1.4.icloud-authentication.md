# <!-- Powered by BMAD™ Core -->

# Story 1.4: iCloud Authentication and Family Account Management

## Status
Draft

## Story
**As a** developer,
**I want** to implement basic user authentication with iCloud,
**so that** families can securely access their data and settings.

## Acceptance Criteria
1. iCloud authentication system is implemented
2. User account status detection (`CKContainer.accountStatus()`)
3. Family account structure supports parent and children profiles
4. Single parent can create family account
5. Data isolation ensures each family only sees their own data
6. Account recovery mechanisms are in place for forgotten passwords (iCloud native)
7. Basic parent authorization flow implemented (Face ID/Touch ID via AuthorizationCenter)
8. **Authentication integration validation** - Test complete auth flow before Epic 2
   - Verify iCloud account detection works on physical device
   - Test Family account creation with real CloudKit writes
   - Validate parent authorization via Family Controls framework
   - Confirm data isolation by creating test records in different zones
9. **Authentication error handling tested**
   - Handle "iCloud account not available" gracefully
   - Handle "Family Controls authorization denied" scenario
   - Test authentication flow with restricted/child accounts

## Tasks / Subtasks

- [ ] Task 1: Implement iCloud Authentication Service (AC: 1, 2, 8)
  - [ ] Create `CloudKitAuthService` class in CloudKitService package
  - [ ] Implement account status detection using `CKContainer.accountStatus()`
  - [ ] Add authentication state management with Combine publishers
  - [ ] Create unit tests for authentication service
  - [ ] Test iCloud account detection on physical device

- [ ] Task 2: Family Account Structure Implementation (AC: 3, 4, 5, 8)
  - [ ] Extend `Family` model with owner and shared user tracking
  - [ ] Implement family creation flow with proper CloudKit zone setup
  - [ ] Add data isolation mechanisms using CloudKit zones
  - [ ] Create family lookup and management methods
  - [ ] Test family account creation with real CloudKit writes
  - [ ] Verify data isolation between different families

- [ ] Task 3: Parent Authorization Flow (AC: 7, 8, 9)
  - [ ] Integrate Face ID/Touch ID authentication via AuthorizationCenter
  - [ ] Implement parent role verification using Family Controls
  - [ ] Add authorization state caching with appropriate timeouts
  - [ ] Create authorization UI components in DesignSystem
  - [ ] Test parent authorization via Family Controls framework
  - [ ] Handle "Family Controls authorization denied" scenario

- [ ] Task 4: Error Handling and Recovery (AC: 6, 9)
  - [ ] Implement graceful handling of "iCloud account not available"
  - [ ] Add account recovery guidance for users
  - [ ] Handle authentication flow with restricted/child accounts
  - [ ] Create user-friendly error messages for all auth scenarios
  - [ ] Add logging for authentication errors for debugging

- [ ] Task 5: Integration Testing and Validation (AC: 8, 9)
  - [ ] Create end-to-end authentication flow test
  - [ ] Test all error scenarios with proper mocks
  - [ ] Validate authentication on physical devices
  - [ ] Run regression tests with existing CloudKit functionality
  - [ ] Document test results and performance metrics

## Dev Notes

### Previous Story Insights
Key learnings from Story 1.3 implementation:
- Successfully created comprehensive CloudKit schema with all required record types
- Implemented CloudKitZoneManager for per-child data isolation
- Created repository protocols for all data models
- Established CoreData schema for local caching
- Implemented COPPA compliance measures for child data protection
- Completed schema validation tests for all record types
- Repository integration tests passed with real CloudKit Development environment

### Technology Stack Requirements [Source: architecture/tech-stack.md]
- **Authentication:** iCloud + Family Sharing (iOS 15.0+) - User authentication
- **Backend Framework:** CloudKit Framework (iOS 15.0+) - Serverless backend
- **State Management:** Combine + SwiftUI @Published pattern
- **Security:** Native iOS security frameworks for biometric authentication

### Project Structure and Architecture [Source: architecture/unified-project-structure.md]
```
ScreenTimeRewards/
├── ScreenTimeRewards/                      # Main iOS app
│   ├── App/
│   ├── Features/
│   └── Resources/
├── Packages/                               # Local Swift packages
│   ├── RewardCore/
│   ├── CloudKitService/
│   ├── FamilyControlsKit/
│   ├── SubscriptionService/
│   ├── DesignSystem/
│   ├── SharedModels/
│   └── AppIntents/
├── Tests/
└── Package.swift
```

### Data Models [Source: architecture/data-models.md]
- `Family` - Family unit with multiple parents and children
  - Fields: id, name, createdAt, ownerUserID, sharedWithUserIDs, childProfileIDs
- `ChildProfile` - Individual child account with point balance
  - Fields: id, familyID, name, avatarAssetURL, birthDate, pointBalance, etc.
- CloudKit zone isolation for per-child data privacy

### Authentication Architecture [Source: architecture/backend-architecture.md]
- iCloud authentication as primary identity provider
- CloudKit shared zones for family data sharing
- Biometric authentication (Face ID/Touch ID) for parent authorization
- Family Controls framework for parent/child role verification

### File Locations and Naming
- Authentication service: `Packages/CloudKitService/Sources/CloudKitService/CloudKitAuthService.swift`
- Extended data models: `Packages/SharedModels/Sources/SharedModels/Models.swift`
- Authentication UI components: `Packages/DesignSystem/Sources/DesignSystem/Components/`
- Unit tests: `Packages/CloudKitService/Tests/CloudKitServiceTests/CloudKitAuthServiceTests.swift`

### Technical Constraints [Source: architecture/tech-stack.md]
- **iOS Version:** 15.0+ required (CloudKit framework dependency)
- **Authentication:** iCloud account required for app functionality
- **Family Sharing:** Native iCloud Family Sharing for multi-parent support
- **Biometric Auth:** Face ID/Touch ID for parent authorization
- **Privacy:** COPPA compliance with age verification and parental consent

### Security and Privacy Considerations
- iCloud authentication provides secure identity management
- CloudKit end-to-end encryption for data at rest and in transit
- Biometric authentication for parent authorization
- Family Controls framework for role-based access control
- COPPA compliance with age verification and parental consent requirements
- Proper error handling that doesn't expose sensitive information

## Testing

### Test Location [Source: architecture/testing-strategy.md]
- Unit tests in `Tests/CloudKitServiceTests/` directory
- Integration tests in `Tests/IntegrationTests/` directory

### Testing Standards [Source: architecture/testing-strategy.md]
- **Framework:** XCTest native framework
- **Pyramid:** 70% Unit, 20% Integration, 10% E2E
- **Naming:** Descriptive test method names (e.g., `testCloudKitAuth_AvailableAccount_ReturnsAuthenticated`)
- **Coverage:** All public CloudKitService authentication interfaces must have unit tests

### Specific Testing Requirements
- Test iCloud authentication with mock implementations
- Verify family account creation and management
- Test parent authorization flow with biometric authentication
- Validate data isolation between different families
- Test all error scenarios and edge cases
- Physical device testing for authentication flow validation
- Test integration with existing CloudKit functionality

### Authentication Testing Notes
- iCloud authentication requires physical device for complete testing
- Family account creation must be tested with real CloudKit writes
- Parent authorization requires Family Controls framework integration
- Data isolation testing critical for family privacy
- Error handling must be comprehensive and user-friendly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-26 | 1.0 | Initial story creation from Epic 1 requirements | James (Developer Agent) |

## Dev Agent Record

### Agent Model Used
James (Full Stack Developer)

### Debug Log References
- No debugging issues encountered during story creation
- All requirements extracted from PRD and architecture documents
- Dependencies on previous stories properly identified

### Completion Notes List
- Created comprehensive story for iCloud authentication implementation
- Defined all acceptance criteria based on PRD requirements
- Identified technical dependencies on previous stories
- Specified testing requirements for authentication functionality
- Documented security and privacy considerations

### File List
**Core Authentication Implementation:**
- `Packages/CloudKitService/Sources/CloudKitService/CloudKitAuthService.swift` - iCloud authentication service with account status detection
- `Packages/SharedModels/Sources/SharedModels/Models.swift` - Extended Family model with owner/shared user tracking
- `Packages/DesignSystem/Sources/DesignSystem/Components/AuthViews.swift` - Authentication UI components
- `Packages/CloudKitService/Package.swift` - Package definition updates

**Testing Infrastructure:**
- `Packages/CloudKitService/Tests/CloudKitServiceTests/CloudKitAuthServiceTests.swift` - Unit tests for authentication service
- `Packages/CloudKitService/Tests/CloudKitServiceTests/FamilyAccountTests.swift` - Unit tests for family account management
- `Packages/CloudKitService/Tests/CloudKitServiceTests/AuthIntegrationTests.swift` - Integration tests for authentication flow
- `Tests/IntegrationTests/AuthenticationValidationTests.swift` - End-to-end authentication validation tests

## QA Results

*This section will be populated by QA Agent after story completion*