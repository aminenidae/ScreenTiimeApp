# <!-- Powered by BMADâ„¢ Core -->

# Story 4.4: Notifications Progress Tracking

## Status
Draft

## Story
**As a** parent,
**I want** to receive notifications about my child's progress,
**so that** I can stay engaged with their educational journey.

## Acceptance Criteria
1. Notification system is implemented for key events
2. Parents can customize notification preferences
3. Notifications are timely and relevant
4. Notification frequency is reasonable to avoid annoyance

## Tasks / Subtasks

- [ ] Task 1: Implement notification system infrastructure (AC: 1)
  - [ ] Create NotificationService in RewardCore package
  - [ ] Integrate UserNotifications framework for local notifications
  - [ ] Set up notification authorization request flow
  - [ ] Create NotificationEvent enum for different event types

- [ ] Task 2: Implement key progress notification events (AC: 1)
  - [ ] Points earned notifications (daily summary)
  - [ ] Learning goal achievement notifications
  - [ ] Weekly progress milestone notifications
  - [ ] Streak achievement notifications

- [ ] Task 3: Create notification preferences UI (AC: 2)
  - [ ] Add notification settings section to Settings screen
  - [ ] Implement toggle switches for each notification type
  - [ ] Add time preference settings (quiet hours)
  - [ ] Save preferences to ChildProfile model

- [ ] Task 4: Implement intelligent notification scheduling (AC: 3, 4)
  - [ ] Create notification batching logic to avoid spam
  - [ ] Implement quiet hours respect (no notifications during sleep)
  - [ ] Add notification cooldown periods between similar events
  - [ ] Create daily digest option instead of real-time alerts

- [ ] Task 5: Add notification history and management (AC: 4)
  - [ ] Create notification history view in Settings
  - [ ] Add clear all notifications option
  - [ ] Implement notification delivery tracking
  - [ ] Add opt-out option for all notifications

- [ ] Task 6: Write comprehensive tests for notification system (AC: 1-4)
  - [ ] Unit tests for NotificationService
  - [ ] UI tests for notification settings
  - [ ] Integration tests for notification delivery
  - [ ] Mock notification scenarios for different user states

## Dev Notes

### Previous Story Insights
No specific insights from previous stories required for this implementation.

### Data Models
**NotificationPreferences** (part of ChildProfile):
- `enabledNotifications`: Set of NotificationEvent enum values
- `quietHoursStart`: Date (time component only)
- `quietHoursEnd`: Date (time component only)
- `digestMode`: Bool (daily digest vs real-time)
- `lastNotificationSent`: Date (for cooldown tracking)
[Source: architecture/data-models.md#ChildProfile]

**NotificationEvent enum values:**
- `.pointsEarned`, `.goalAchieved`, `.weeklyMilestone`, `.streakAchieved`
[Source: architecture/data-models.md - inferred from context]

### API Specifications
No external API specifications required - uses native iOS UserNotifications framework.
[Source: architecture/tech-stack.md#Local Notifications]

### Component Specifications
**NotificationSettingsView** component:
- Location: `ScreenTimeRewards/Features/Settings/Views/NotificationSettingsView.swift`
- Props: `viewModel: NotificationSettingsViewModel`
- Uses DesignSystem toggle components and section headers
[Source: architecture/frontend-architecture.md, architecture/unified-project-structure.md]

**NotificationService** service:
- Location: `Packages/RewardCore/Sources/RewardCore/Services/NotificationService.swift`
- Uses UserNotifications framework with privacy-first approach
- Implements batching and intelligent scheduling logic
[Source: architecture/tech-stack.md#Local Notifications]

### File Locations
Based on unified project structure:
- Service: `Packages/RewardCore/Sources/RewardCore/Services/NotificationService.swift`
- Settings UI: `ScreenTimeRewards/Features/Settings/Views/NotificationSettingsView.swift`
- ViewModel: `ScreenTimeRewards/Features/Settings/ViewModels/NotificationSettingsViewModel.swift`
- Data Models: Extend existing ChildProfile in `Packages/SharedModels/Sources/SharedModels/ChildProfile.swift`
- Tests: `Tests/ScreenTimeRewardsTests/Features/Settings/NotificationSettingsTests.swift`
[Source: architecture/unified-project-structure.md]

### Testing Requirements
**Unit Testing (70% of tests):**
- Test NotificationService scheduling logic
- Test notification preference validation
- Test quiet hours calculation
- Test cooldown period enforcement

**Integration Testing (20% of tests):**
- Test notification settings UI integration
- Test notification delivery with CloudKit sync
- Test notification permission flow

**E2E Testing (10% of tests):**
- Test complete notification setup flow
- Test notification delivery in app lifecycle scenarios
[Source: architecture/testing-strategy.md]

### Technical Constraints
- iOS 15.0+ UserNotifications framework support
- COPPA compliance: No push notifications to children under 13 without explicit parental consent
- Battery impact: Minimize background processing for notification scheduling
- Privacy: All notifications processed locally, no server-side notification service
[Source: architecture/tech-stack.md#Local Notifications, COPPA requirements]

## Testing

### Testing Standards
**Test File Locations:**
- Unit tests: `Tests/RewardCoreTests/Services/NotificationServiceTests.swift`
- UI tests: `Tests/ScreenTimeRewardsTests/Features/Settings/NotificationSettingsUITests.swift`
- Integration tests: `Tests/ScreenTimeRewardsTests/Integration/NotificationIntegrationTests.swift`

**Testing Frameworks:**
- XCTest for unit and integration testing
- XCUITest for end-to-end UI testing
- Mock UserNotifications for controlled testing scenarios

**Testing Patterns:**
- Repository pattern mocking for CloudKit dependencies
- Notification delivery simulation for testing
- Time-based testing with controlled date mocking

**Specific Testing Requirements:**
- Test notification authorization flow
- Test quiet hours enforcement across timezone changes
- Test notification batching prevents spam
- Test COPPA compliance for child notification consent
[Source: architecture/testing-strategy.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 1.0 | Initial story creation for notification progress tracking | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after story completion*