# <!-- Powered by BMAD™ Core -->

# Story 2.1: Parent App Categorization Interface

## Status
Approved

## Story
**As a** parent,
**I want** to categorize apps as "learning" or "reward" with customizable point values,
**so that** I can control which activities earn rewards and how much they're worth.

## Acceptance Criteria
1. **Interface for browsing and categorizing installed apps is implemented** (uses App Discovery Service from Story 1.7)
2. Parents can assign custom point values per hour for each app category
3. System validates app categorization and prevents conflicts
4. Categorized apps are saved and persist between app sessions
5. **App categorization UI handles app metadata** (names, icons from Story 1.7 services)

## Tasks / Subtasks

- [ ] Task 1: Create App Categorization Screen (AC: 1, 5)
  - [ ] Design and implement the main App Categorization view
  - [ ] Integrate with AppDiscoveryService to fetch installed apps
  - [ ] Display app metadata (names, icons) using AppMetadataService
  - [ ] Implement search and filtering capabilities
  - [ ] Create unit tests for the view model

- [ ] Task 2: Implement Category Assignment (AC: 1, 2, 3)
  - [ ] Add UI controls for assigning apps to "Learning" or "Reward" categories
  - [ ] Implement point value input fields for each category
  - [ ] Add validation to prevent conflicts (e.g., same app in both categories)
  - [ ] Create repository methods to save categorization data
  - [ ] Write unit tests for categorization logic

- [ ] Task 3: Data Persistence (AC: 4)
  - [ ] Implement CloudKit storage for app categorization data
  - [ ] Create AppCategorizationRepository with CloudKit implementation
  - [ ] Ensure data persists between app sessions
  - [ ] Add synchronization with CloudKit for multi-device support
  - [ ] Create integration tests for data persistence

- [ ] Task 4: User Experience Enhancements
  - [ ] Implement bulk categorization options
  - [ ] Add visual feedback when apps are categorized
  - [ ] Create empty states and loading indicators
  - [ ] Implement pull-to-refresh functionality
  - [ ] Add accessibility support for all UI elements

## Dev Notes

### Previous Story Insights
Key learnings from Story 1.7 (App Discovery and Metadata Services Foundation):
- Successfully implemented AppDiscoveryService in FamilyControlsKit package
- Created AppMetadataService for fetching app display names, icons, and bundle identifiers
- Established InstalledAppsRepository protocol in CloudKitService package
- Validated integration with CloudKit zone-based architecture
- Completed physical device testing for Family Controls functionality

### Dependencies
- Story 1.7 (App Discovery Service - moved from 2.0)

### Technology Stack Requirements [Source: architecture/tech-stack.md]
- **Frontend Language:** Swift 5.9+
- **Frontend Framework:** SwiftUI iOS 15.0+
- **Backend Framework:** CloudKit Framework iOS 15.0+
- **Database:** CloudKit (Primary) + CoreData (Cache)
- **State Management:** Combine + SwiftUI @Published
- **Screen Time Integration:** Family Controls Framework iOS 15.0+
- **Testing:** XCTest + SwiftUI Previews

### Project Structure and Architecture [Source: architecture/unified-project-structure.md]
```
ScreenTimeRewards/
├── ScreenTimeRewards/                      # Main iOS app
│   ├── App/
│   ├── Features/
│   │   ├── ParentDashboard/
│   │   ├── ChildDashboard/
│   │   ├── AppCategorization/              # New feature directory
│   │   ├── RewardRedemption/
│   │   └── Settings/
│   └── Resources/
├── Packages/                               # Local Swift packages
│   ├── RewardCore/
│   ├── CloudKitService/
│   ├── FamilyControlsKit/                  # Contains AppDiscoveryService
│   ├── SubscriptionService/
│   ├── DesignSystem/
│   ├── SharedModels/
│   └── AppIntents/
```

### File Locations and Naming
- App Categorization View: `ScreenTimeRewards/Features/AppCategorization/AppCategorizationView.swift`
- App Categorization ViewModel: `ScreenTimeRewards/Features/AppCategorization/AppCategorizationViewModel.swift`
- App Categorization Repository: `Packages/CloudKitService/Sources/CloudKitService/AppCategorizationRepository.swift`
- App Categorization Data Models: `Packages/SharedModels/Sources/SharedModels/AppCategorization.swift`
- Unit tests: `Tests/ScreenTimeRewardsTests/Features/AppCategorization/`
- Integration tests: `Tests/IntegrationTests/AppCategorizationTests/`

### Technical Constraints [Source: architecture/tech-stack.md]
- **iOS Version:** 15.0+ required (Family Controls framework dependency)
- **Device Requirement:** Physical device required for Family Controls testing
- **Framework Dependency:** Native Family Controls framework only
- **Privacy Compliance:** COPPA regulations must be maintained
- **Performance:** Efficient caching required for app icons

### Data Models [Source: architecture/source-tree.md]
- AppCategorization model with fields:
  - appBundleID (String)
  - categoryName (String - "Learning" or "Reward")
  - pointsPerHour (Int)
  - createdAt (Date)
  - updatedAt (Date)

### Security and Privacy Considerations
- Family Controls framework requires user consent
- Proper error handling for authorization failures
- Secure storage of categorization data in CloudKit
- Respect privacy boundaries for app data

## Testing

### Test Location [Source: architecture/testing-strategy.md]
- Unit tests in `Tests/ScreenTimeRewardsTests/Features/AppCategorization/` directory
- Integration tests in `Tests/IntegrationTests/AppCategorizationTests/` directory

### Testing Standards [Source: architecture/testing-strategy.md]
- **Framework:** XCTest native framework
- **Pyramid:** 70% Unit, 20% Integration, 10% E2E
- **Naming:** Descriptive test method names
- **Coverage:** All public interfaces must have unit tests

### Specific Testing Requirements
- Test App Categorization View with various app lists
- Verify category assignment logic with edge cases
- Test point value validation and error handling
- Validate data persistence with CloudKit integration
- Test conflict detection and resolution
- Verify search and filtering functionality
- Test bulk categorization features
- Physical device testing for Family Controls integration
- Accessibility testing for all UI elements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-26 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-26 | 1.1 | Story approved after checklist validation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used


### Debug Log References


### Completion Notes List


### File List

## QA Results

### Validation Result

| Category                             | Status   | Issues |
| ------------------------------------ | -------- | ------ |
| 1. Goal & Context Clarity            | PASS     |        |
| 2. Technical Implementation Guidance | PASS     |        |
| 3. Reference Effectiveness           | PASS     |        |
| 4. Self-Containment Assessment       | PASS     |        |
| 5. Testing Guidance                  | PASS     |        |

**Final Assessment:**

- READY: The story provides sufficient context for implementation
- Clarity score: 9/10
- Major gaps identified: None

The story clearly defines what needs to be implemented for the parent app categorization interface. All acceptance criteria are well-defined and testable. The tasks provide a clear implementation path with references to the relevant architecture documents. The Dev Notes section includes important context from previous stories and clearly outlines the technology stack, file locations, and constraints. Testing requirements are clearly specified with references to the testing strategy document.

### Checklist Validation Details

#### 1. Goal & Context Clarity
- [x] Story goal/purpose is clearly stated
- [x] Relationship to epic goals is evident
- [x] How the story fits into overall system flow is explained
- [x] Dependencies on previous stories are identified (Story 1.7)
- [x] Business context and value are clear

#### 2. Technical Implementation Guidance
- [x] Key files to create/modify are identified
- [x] Technologies specifically needed for this story are mentioned
- [x] Critical APIs or interfaces are sufficiently described
- [x] Necessary data models or structures are referenced
- [x] Any exceptions to standard coding patterns are noted

#### 3. Reference Effectiveness
- [x] References to external documents point to specific relevant sections
- [x] Critical information from previous stories is summarized
- [x] Context is provided for why references are relevant
- [x] References use consistent format

#### 4. Self-Containment Assessment
- [x] Core information needed is included
- [x] Implicit assumptions are made explicit
- [x] Domain-specific terms or concepts are explained
- [x] Edge cases or error scenarios are addressed

#### 5. Testing Guidance
- [x] Required testing approach is outlined
- [x] Key test scenarios are identified
- [x] Success criteria are defined
- [x] Special testing considerations are noted
